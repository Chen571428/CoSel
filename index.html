<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <link href="https://raw.githubusercontent.com/Chen571428/picx-images-hosting/refs/heads/master/favicon.ico" rel="icon" type="image/x-icon">
  <title>PKU CoSel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
</head>
<body>
  <div id="app">
    <v-app>
      <v-main>
        <v-container fluid>
          <v-app-bar 
            app 
            :class="$vuetify.theme.dark ? 'glassmorphism-dark' : 'glassmorphism-light'"
            elevation="0"
          >
            <div class="blur-background"></div>
            <v-toolbar-title class="pl-4 font-weight-medium">
              PKU CoSel | 白鲸大学手动选课辅助工具
            </v-toolbar-title>
            <v-spacer></v-spacer>
            <v-btn 
              icon 
              class="theme-toggle-btn"
              @click="$vuetify.theme.dark = !$vuetify.theme.dark"
            >
              <v-icon>{{ $vuetify.theme.dark ? 'mdi-weather-sunny' : 'mdi-weather-night' }}</v-icon>
            </v-btn>
          </v-app-bar>

          <v-fade-transition>
            <v-toolbar
              flat
              :color="$vuetify.theme.dark ? 'grey darken-3' : 'grey lighten-4'"
              class="mb-4 search-toolbar elevation-2"
              rounded
            >
              <v-container class="pa-0">
                <v-row align="center" justify="center" class="search-row">
                  <v-col cols="12" sm="4" md="3" class="search-col">
                    <v-text-field
                      v-model="search"
                      append-icon="mdi-magnify"
                      label="搜索课程"
                      hide-details
                      dense
                      :dark="$vuetify.theme.dark"
                      :background-color="$vuetify.theme.dark ? 'grey darken-2' : 'white'"
                      class="search-field rounded-lg"
                      filled
                      rounded
                    ></v-text-field>
                  </v-col>

                  <v-col cols="12" sm="4" md="3" class="search-col">
                    <v-combobox
                      v-model="selectedDepartments"
                      :items="departments"
                      label="开课单位"
                      multiple
                      clearable
                      chips
                      small-chips
                      deletable-chips
                      dense
                      hide-details
                      :dark="$vuetify.theme.dark"
                      :background-color="$vuetify.theme.dark ? 'grey darken-2' : 'white'"
                      class="search-field rounded-lg"
                      filled
                      rounded
                    >
                      <template v-slot:selection="{ attrs, item, select, selected }">
                        <v-chip
                          v-bind="attrs"
                          :input-value="selected"
                          close
                          @click="select"
                          @click:close="removeItem(item, selectedDepartments)"
                          small
                          class="custom-chip"
                        >
                          {{ item }}
                        </v-chip>
                      </template>
                    </v-combobox>
                  </v-col>

                  <v-col cols="12" sm="4" md="3" class="search-col">
                    <v-combobox
                      v-model="selectedWeekdays"
                      :items="weekdays"
                      label="上课时间"
                      multiple
                      clearable
                      chips
                      small-chips
                      deletable-chips
                      dense
                      hide-details
                      :dark="$vuetify.theme.dark"
                      :background-color="$vuetify.theme.dark ? 'grey darken-2' : 'white'"
                      class="search-field rounded-lg"
                      filled
                      rounded
                    >
                      <template v-slot:selection="{ attrs, item, select, selected }">
                        <v-chip
                          v-bind="attrs"
                          :input-value="selected"
                          close
                          @click="select"
                          @click:close="removeItem(item, selectedWeekdays)"
                          small
                          class="custom-chip"
                        >
                          {{ item }}
                        </v-chip>
                      </template>
                    </v-combobox>
                  </v-col>
                </v-row>
              </v-container>
            </v-toolbar>
          </v-fade-transition>

          <v-slide-y-transition>
            <v-data-table
              :headers="headers"
              :items="filteredCourses"
              :search="search"
              :custom-filter="() => true"
              :items-per-page="itemsPerPage"
              :footer-props="{
                'items-per-page-options': [10, 20, 25, 50, 100, -1],
                'items-per-page-text': '每页显示:',
                'items-per-page-all-text': '全部',
                showFirstLastPage: true,
                'first-icon': 'mdi-page-first',
                'last-icon': 'mdi-page-last',
                'prev-icon': 'mdi-chevron-left',
                'next-icon': 'mdi-chevron-right'
              }"
              class="elevation-2"
              :loading="loading"
              loading-text="加载中..."
            >
              <template v-slot:item.课程号="{ item }">
                <a 
                  :href="getCourseDetailUrl(item)"
                  target="_blank"
                  class="course-link"
                  v-tooltip="'点击查看课程详情'"
                >
                  {{ item.课程号 }}
                </a>
              </template>
              
              <template v-slot:item.课程名称="{ item }">
                <a 
                  :href="getCourseDetailUrl(item)"
                  target="_blank"
                  class="course-link"
                  v-tooltip="'点击查看课程详情'"
                >
                  {{ item.课程名称 }}
                </a>
              </template>

              <template v-slot:item.班号="{ item }">
                <v-chip color="indigo" dark small>
                  {{ item.班号 }}
                </v-chip>
              </template>

              <template v-slot:item.学分="{ item }">
                <v-chip color="teal" dark>
                  {{ item.学分 }} 学分
                </v-chip>
              </template>

              <template v-slot:item.上课时间="{ item }">
                <div class="text-caption">
                  {{ formatWeekday(item.上课时间) }}<br>
                  {{ formatTimePeriod(item.上课时间) }}
                </div>
              </template>

              <template v-slot:item.备注="{ item }">
                <v-tooltip bottom max-width="300">
                  <template v-slot:activator="{ on }">
                    <v-icon small v-on="on">mdi-information</v-icon>
                  </template>
                  <span>{{ item.备注 }}</span>
                </v-tooltip>
              </template>

              <template v-slot:item.操作="{ item }">
                <template v-if="isCourseSelected(item)">
                  <v-btn
                    small
                    color="error"
                    @click="removeCourseByItem(item)"
                  >
                    取消
                  </v-btn>
                </template>
                <template v-else>
                  <v-btn
                    small
                    color="primary"
                    @click="selectCourse(item, false)"
                  >
                    选课
                  </v-btn>
                  <v-btn
                    small
                    color="secondary"
                    class="ml-2"
                    @click="selectCourse(item, true)"
                  >
                    旁听
                  </v-btn>
                </template>
              </template>
            </v-data-table>
          </v-slide-y-transition>

          <v-slide-y-transition>
            <v-card class="mt-6 elevation-2">
              <v-card-title class="primary white--text">
                已选课程（总学分：{{ totalCredits }}）
                <v-btn small dark class="ml-4" @click="exportSchedule">
                  <v-icon left>mdi-timetable</v-icon>
                  WakeUP课表导出
                </v-btn>
                <v-btn small dark class="ml-2" @click="$refs.fileInput.click()">
                  <v-icon left>mdi-file-import</v-icon>
                  导入交教务课表
                </v-btn>
                <input
                  type="file"
                  ref="fileInput"
                  accept=".csv"
                  style="display: none"
                  @change="handleFileUpload"
                >
                <v-btn small dark class="ml-2" @click="dialog = true">
                  <v-icon left>mdi-account-school</v-icon>
                  交教务课表导出
                </v-btn>
                <v-chip 
                  :class="$vuetify.theme.dark ? 'conflict-chip' : 'error'"
                  small 
                  class="ml-2" 
                  v-if="hasTimeConflict"
                >
                  <v-icon left small>mdi-alert-circle</v-icon>
                  存在时间冲突！
                </v-chip>
                <v-btn small dark class="ml-2" @click="showTimetable = !showTimetable">
                  <v-icon left>mdi-calendar</v-icon>
                  {{ showTimetable ? '列表视图' : '时间表视图' }}
                </v-btn>
              </v-card-title>

              <v-alert
                :type="creditAlertType"
                dense
                v-if="showCreditAlert"
                class="mb-0"
              >
                {{ creditAlertMessage }}
              </v-alert>

              <v-dialog v-model="dialog" max-width="500">
                <v-card>
                  <v-card-title class="headline">学生信息</v-card-title>
                  <v-card-text>
                    <v-text-field
                      v-model="studentId"
                      label="旁听证号"
                      outlined
                      clearable
                      required
                      class="mb-4"
                      :rules="[v => !!v || '必须填写旁听证号']"
                    ></v-text-field>
                    <v-text-field
                      v-model="studentName"
                      label="学生姓名"
                      outlined
                      clearable
                      required
                      :rules="[v => !!v || '必须填写姓名']"
                    ></v-text-field>
                  </v-card-text>
                  <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn color="error" @click="dialog = false">取消</v-btn>
                    <v-btn color="primary" @click="exportSelectionList">导出CSV</v-btn>
                  </v-card-actions>
                </v-card>
              </v-dialog>

              <template v-if="showTimetable">
                <v-row class="px-4 py-2" align="center">
                  <v-col cols="auto">
                    <v-select
                      v-model="currentWeek"
                      :items="weekOptions"
                      label="选择周次"
                      dense
                      style="max-width: 150px"
                    ></v-select>
                  </v-col>
                  <v-col>
                    <v-chip small>{{ isCurrentWeekOdd ? '单周' : '双周' }}</v-chip>
                  </v-col>
                </v-row>

                <v-simple-table class="timetable-container">
                  <template v-slot:default>
                    <thead>
                      <tr>
                        <th class="text-center time-column">时间</th>
                        <th 
                          v-for="dateInfo in weekDates" 
                          :key="dateInfo.weekday" 
                          class="text-center weekday-column"
                        >
                          {{ dateInfo.weekday }}<br>
                          <span class="text-caption">{{ dateInfo.month }}/{{ dateInfo.date }}</span>
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="(period, index) in schedule" :key="index">
                        <td class="text-center time-column">
                          {{ period.time }}<br>
                          <span class="text-caption">{{ period.period }}</span>
                        </td>
                        <td 
                          v-for="(dateInfo, dayIndex) in weekDates" 
                          :key="dateInfo.weekday"
                          class="text-center course-cell-container"
                        >
                          <template v-if="shouldShowCourse(dayIndex, index + 1)">
                            <div :class="getCellClasses(dayIndex, index + 1)">
                              <div class="course-title">
                                <a 
                                  :href="getCourseDetailUrl(getCourseTimeInfo(dayIndex, index + 1).course)"
                                  target="_blank"
                                  class="course-link"
                                  v-tooltip="'点击查看课程详情'"
                                >
                                  {{ getCourseTimeInfo(dayIndex, index + 1).course.课程名称 }}
                                </a>
                              </div>
                              <div class="course-info">
                                {{ getCourseTimeInfo(dayIndex, index + 1).course.教师 }}
                                <br>
                                {{ getCourseTimeInfo(dayIndex, index + 1).course.开课单位 }}
                                <template v-if="getCourseTimeInfo(dayIndex, index + 1).weekType !== 'all'">
                                  <br>
                                  <v-chip x-small class="week-type-chip">
                                    {{ getCourseTimeInfo(dayIndex, index + 1).weekType }}周
                                  </v-chip>
                                </template>
                              </div>
                            </div>
                          </template>
                        </td>
                      </tr>
                    </tbody>
                  </template>
                </v-simple-table>
              </template>

              <v-list two-line v-else>
                <v-list-item
                  v-for="(course, index) in selectedCourses"
                  :key="index"
                  :class="{'conflict-item': hasConflict(course), 'audit-item': course.isAudit}"
                >
                  <v-list-item-content>
                    <v-list-item-title>
                      <v-tooltip bottom>
                        <template v-slot:activator="{ on, attrs }">
                          <a 
                            :href="getCourseDetailUrl(course)"
                            target="_blank"
                            class="course-link"
                            v-bind="attrs"
                            v-on="on"
                          >
                            {{ course.课程名称 }}
                          </a>
                        </template>
                        <span>点击查看课程详情</span>
                      </v-tooltip>
                      <v-chip v-if="course.isAudit" x-small color="grey" class="ml-1">旁听</v-chip>
                    </v-list-item-title>
                    <v-list-item-subtitle>
                      <template v-for="(time, index) in parseTime(course)">
                        {{ weekdays[time.weekday - 1] }} 第{{ time.start }}-{{ time.end }}节
                        <template v-if="time.weekType !== 'all'">({{ time.weekType }})</template>
                        <template v-if="index < parseTime(course).length - 1">、</template>
                      </template>
                      | 教师：{{ course.教师 }} | 
                      班号：{{ course.班号 }} | 
                      学分：{{ course.学分 }}
                      <v-chip 
                        x-small 
                        :class="$vuetify.theme.dark ? 'conflict-chip' : 'error'"
                        v-if="hasConflict(course)"
                      >
                        <v-icon left x-small>mdi-alert-circle</v-icon>
                        时间冲突
                      </v-chip>
                    </v-list-item-subtitle>
                  </v-list-item-content>
                  
                  <v-list-item-action>
                    <v-switch
                      v-model="course.isAudit"
                      label="旁听"
                      dense
                      hide-details
                      color="primary"
                      class="mt-0"
                    ></v-switch>
                    <v-btn icon @click="removeCourse(index)">
                      <v-icon color="red">mdi-delete</v-icon>
                    </v-btn>
                  </v-list-item-action>
                </v-list-item>
              </v-list>
            </v-card>
          </v-slide-y-transition>
        </v-container>
      </v-main>
    </v-app>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  
  <script>
    new Vue({
      el: '#app',
      vuetify: new Vuetify({
        theme: {
          dark: false, // 默认使用亮色主题
          options: {
            customProperties: true, // 启用CSS变量
          },
          themes: {
            light: {
              primary: '#1976D2',
              secondary: '#424242',
              accent: '#82B1FF',
              error: '#FF5252',
              info: '#2196F3',
              success: '#4CAF50',
              warning: '#FFC107'
            },
            dark: {
              primary: '#2196F3',
              secondary: '#757575',
              accent: '#82B1FF',
              error: '#FF5252',
              info: '#2196F3',
              success: '#4CAF50',
              warning: '#FFC107'
            }
          }
        }
      }),
      data: () => ({
        courses: [], // 初始为空数组
        search: '',
        selectedDepartments: [],
        selectedWeekdays: [],
        selectedCourses: [],
        dialog: false,
        studentId: '',
        studentName: '',
        itemsPerPage: 10,
        headers: [
          { text: '课程号', value: '课程号', width: '120px' },
          { text: '班号', value: '班号', width: '80px' },
          { text: '课程名称', value: '课程名称', minWidth: '200px' },
          { text: '课程类型', value: '课程类型', width: '120px' },
          { text: '开课单位', value: '开课单位', width: '150px' },
          { text: '学分', value: '学分', width: '100px' },
          { text: '上课时间', value: '上课时间', width: '150px' },
          { text: '教师', value: '教师', width: '120px' },
          { text: '备注', value: '备注', width: '80px' },
          { text: '操作', value: '操作', width: '150px' }
        ],
        showTimetable: false,
        tab: null,
        schedule: [
          { period: "第一节", time: "08:00—08:50" },
          { period: "第二节", time: "09:00—09:50" },
          { period: "第三节", time: "10:10—11:00" },
          { period: "第四节", time: "11:10—12:00" },
          { period: "第五节", time: "13:00—13:50" },
          { period: "第六节", time: "14:00—14:50" },
          { period: "第七节", time: "15:10—16:00" },
          { period: "第八节", time: "16:10—17:00" },
          { period: "第九节", time: "17:10—18:00" },
          { period: "第十节", time: "18:40—19:30" },
          { period: "第十一节", time: "19:40—20:30" },
          { period: "第十二节", time: "20:40—21:30" }
        ],
        currentWeek: 1,
        semesterStartDate: new Date(2025, 1, 17), // 2025年2月17日，注意月份从0开始
        totalWeeks: 18,
      }),
      async created() {
        try {
          const response = await fetch('https://raw.githubusercontent.com/Chen571428/CoSel/refs/heads/main/getCourseList/unique_courses.csv');
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          const csvText = await response.text();
          // 处理可能的BOM字符
          const cleanCsvText = csvText.replace(/^\uFEFF/, '');
          // 使用原有的csvToJSON方法转换数据
          this.courses = this.csvToJSON(cleanCsvText).map(course => ({
            ...course,
            weekday: course.上课时间.match(/星期[一二三四五六日]/)?.[0] || ''
          }));
        } catch (error) {
          console.error('Error fetching course data:', error);
          alert('获取课程数据失败，请刷新页面重试');
        }
      },
      computed: {
        departments() {
          return [...new Set(this.courses.map(c => c.开课单位))];
        },
        weekdays() {
          return ['星期一', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'];
        },
        filteredCourses() {
          return this.courses.filter(course => {
            const departmentMatch = this.selectedDepartments.length === 0 || 
              this.selectedDepartments.includes(course.开课单位);
            const weekdayMatch = this.selectedWeekdays.length === 0 || 
              this.selectedWeekdays.includes(this.formatWeekday(course.上课时间));
            const searchMatch = !this.search || 
              Object.values(course).some(value => 
                value.toString().toLowerCase().includes(this.search.toLowerCase())
              );
            return departmentMatch && weekdayMatch && searchMatch;
          });
        },
        totalCredits() {
          return this.selectedCourses
            .filter(c => !c.isAudit)
            .reduce((sum, c) => sum + Number(c.学分), 0);
        },
        timeConflicts() {
          const conflicts = [];
          
          // 遍历所有已选课程
          for (let i = 0; i < this.selectedCourses.length; i++) {
            const course1 = this.selectedCourses[i];
            const times1 = this.parseTime(course1);
            
            // 与后续的每个课程比较
            for (let j = i + 1; j < this.selectedCourses.length; j++) {
              const course2 = this.selectedCourses[j];
              const times2 = this.parseTime(course2);
              
              // 检查两个课程的所有时间段是否存在冲突
              const hasConflict = times1.some(t1 => 
                times2.some(t2 => this.checkTimeConflict(t1, t2))
              );
              
              if (hasConflict) {
                conflicts.push([course1.id, course2.id]);
              }
            }
          }
          
          return conflicts;
        },
        hasTimeConflict() {
          return this.timeConflicts.length > 0;
        },
        showCreditAlert() {
          return this.totalCredits >= 25;
        },
        creditAlertType() {
          return this.totalCredits >= 30 ? 'error' : 'warning';
        },
        creditAlertMessage() {
          if (this.totalCredits >= 30) return '学分超过限制（≥30），请调整选课！';
          if (this.totalCredits >= 25) return '学分超过推荐值（≥25），请注意学业负担！';
          return '';
        },
        weekOptions() {
          return Array.from({ length: this.totalWeeks }, (_, i) => ({
            text: `第${i + 1}周`,
            value: i + 1
          }));
        },
        weekDates() {
          const dates = [];
          const weekStart = new Date(this.semesterStartDate);
          weekStart.setDate(weekStart.getDate() + (this.currentWeek - 1) * 7);
          
          for (let i = 0; i < 7; i++) {
            const date = new Date(weekStart);
            date.setDate(date.getDate() + i);
            dates.push({
              weekday: this.weekdays[i],
              date: date.getDate(),
              month: date.getMonth() + 1
            });
          }
          return dates;
        },
        isCurrentWeekOdd() {
          return this.currentWeek % 2 === 1;
        }
      },
      methods: {
        formatWeekday(timeStr) {
          const weekdays = timeStr.match(/星期[一二三四五六日]/g) || [];
          return weekdays.join('、');
        },
        formatTimePeriod(timeStr) {
          const periods = timeStr.split(/(?=星期)/).map(segment => {
            const match = segment.match(/\(第(\d+)节-第(\d+)节\)(?:\(([单双])\))?/);
            if (match) {
              const weekType = match[3] ? `(${match[3]})` : '';
              return `第${match[1]}-${match[2]}节${weekType}`;
            }
            return '';
          }).filter(Boolean);
          return periods.join('、');
        },
        selectCourse(course, isAudit) {
          if (!this.isCourseSelected(course)) {
            this.selectedCourses.push({
              ...course,
              id: `${course.课程号}_${course.班号}`,
              isAudit: isAudit
            });
          }
        },
        removeCourse(index) {
          this.selectedCourses.splice(index, 1);
        },
        isCourseSelected(course) {
          return this.selectedCourses.some(c => 
            c.课程号 === course.课程号 && c.班号 === course.班号
          );
        },
        parseTime(course) {
          const weekdayMap = {一:1, 二:2, 三:3, 四:4, 五:5, 六:6, 日:7};
          const times = [];
          
          // 分割多个上课时间段
          const timeSegments = course.上课时间.split(/(?=星期)/);
          
          timeSegments.forEach(segment => {
            const match = segment.match(/星期([一二三四五六日])\(第(\d+)节-第(\d+)节\)(?:\(([单双])\))?/);
            if (match) {
              times.push({
                weekday: weekdayMap[match[1]],
                start: parseInt(match[2]),
                end: parseInt(match[3]),
                weekType: match[4] || 'all', // 'all' 表示每周，'单' 表示单周，'双' 表示双周
                id: course.id
              });
            }
          });
          
          return times;
        },
        checkTimeConflict(time1, time2) {
          // 如果不是同一天，不冲突
          if (time1.weekday !== time2.weekday) return false;
          
          // 检查周类型（单双周）
          if (time1.weekType !== time2.weekType && 
              time1.weekType !== 'all' && 
              time2.weekType !== 'all') {
            return false; // 单周和双周的课不冲突
          }
          
          // 检查时间段是否重叠
          const hasTimeOverlap = (
            (time1.start >= time2.start && time1.start <= time2.end) ||
            (time2.start >= time1.start && time2.start <= time1.end)
          );
          
          return hasTimeOverlap;
        },
        hasConflict(course) {
          return this.timeConflicts.some(pair => 
            pair.includes(course.id)
          );
        },
        exportSchedule() {
          if (this.selectedCourses.length === 0) {
            alert('请先选择课程');
            return;
          }

          const csvRows = [];
          this.selectedCourses.forEach(course => {
            const times = this.parseTime(course);
            const location = this.extractLocation(course.备注);
            const weekRange = this.formatWeekRange(course.起止周);
            
            // 为每个时间段创建一行
            times.forEach(time => {
              csvRows.push([
                course.课程名称,
                time.weekday,
                time.start,
                time.end,
                course.教师,
                location,
                weekRange
              ].map(value => `"${value}"`).join(','));
            });
          });

          const csvContent = "课程名称,星期,开始节数,结束节数,老师,地点,周数\n" + 
            csvRows.join('\n');

          this.downloadCSV(csvContent, 'WakeUP导入.csv');
        },
        exportSelectionList() {
          if (!this.studentId || !this.studentName) {
            alert('请填写旁听证号和姓名');
            return;
          }

          const selectedCourses = this.selectedCourses.filter(course => !course.isAudit);
          
          if (selectedCourses.length === 0) {
            alert('没有正式选课课程');
            this.dialog = false;
            return;
          }

          const csvContent = "旁听证号,姓名,开课院系,课程名称,学分,课程号,班号\n" + 
            selectedCourses.map(course => {
              return [
                this.studentId,
                `"${this.studentName}"`,
                `"${course.开课单位}"`,
                `"${course.课程名称}"`,
                course.学分,
                course.课程号,
                course.班号
              ].join(',');
            }).join('\n');

          this.downloadCSV(csvContent, `${this.studentName}预科选课单.csv`);
          this.dialog = false;
        },
        downloadCSV(content, filename) {
          const blob = new Blob(["\ufeff" + content], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          
          link.setAttribute("href", url);
          link.setAttribute("download", filename);
          link.style.visibility = "hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },
        extractLocation(remark) {
          if (!remark) return '未知地点';
          const locationMatch = remark.match(/([^，,]+?)[，,]/);
          return locationMatch ? locationMatch[1] : remark;
        },
        formatWeekRange(weekStr) {
          if (!weekStr) return '1-16';
          return weekStr
            .replace(/、/g, ',')
            .replace(/，/g, ',')
            .replace(/\s+/g, '');
        },
        getCourseAtTime(weekday, period) {
          return this.selectedCourses.find(course => {
            const times = this.parseTime(course);
            return times.some(time => 
              time.weekday === weekday + 1 && 
              time.start <= period && 
              time.end >= period
            );
          });
        },
        getCourseTimeInfo(weekday, period) {
          const course = this.selectedCourses.find(course => {
            const times = this.parseTime(course);
            return times.some(time => 
              time.weekday === weekday + 1 && 
              time.start <= period && 
              time.end >= period
            );
          });

          if (!course) return null;

          const times = this.parseTime(course);
          const timeInfo = times.find(time => 
            time.weekday === weekday + 1 && 
            time.start <= period && 
            time.end >= period
          );

          return {
            course,
            weekType: timeInfo.weekType
          };
        },
        getCellClasses(weekday, period) {
          const courseInfo = this.getCourseTimeInfo(weekday, period);
          if (!courseInfo || !this.shouldShowCourse(weekday, period)) return '';
          
          const { course, weekType } = courseInfo;
          const isAudit = course.isAudit;
          const hasConflict = this.hasConflict(course);
          
          return [
            'course-cell',
            hasConflict ? 'conflict-cell' : (isAudit ? 'course-audit' : 'course-regular'),
            (weekType === '单' || weekType === '双') ? 'course-alternate' : ''
          ].filter(Boolean).join(' ');
        },
        handleFileUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const csv = e.target.result;
              const courses = this.parseImportedCSV(csv);
              this.importCourses(courses);
              this.$refs.fileInput.value = ''; // 重置文件输入
            } catch (error) {
              alert('导入失败：' + error.message);
            }
          };
          reader.readAsText(file);
        },
        parseImportedCSV(csv) {
          const lines = csv.split('\n');
          if (lines.length < 2) throw new Error('文件格式不正确');

          const headers = lines[0].split(',').map(h => h.trim());
          const requiredHeaders = ['旁听证号', '姓名', '开课院系', '课程名称', '学分', '课程号', '班号'];
          
          // 验证必要的列是否存在
          requiredHeaders.forEach(header => {
            if (!headers.includes(header)) {
              throw new Error(`缺少必要的列：${header}`);
            }
          });

          return lines.slice(1)
            .filter(line => line.trim())
            .map(line => {
              const values = line.split(',').map(v => v.trim());
              const courseData = {};
              headers.forEach((header, index) => {
                courseData[header] = values[index]?.replace(/^"|"$/g, '').trim() || '';
              });
              return courseData;
            });
        },
        importCourses(importedCourses) {
          let imported = 0;
          let skipped = 0;
          let notFound = 0;

          importedCourses.forEach(importedCourse => {
            // 在可用课程中查找匹配的课程
            const course = this.courses.find(c => 
              c.课程号 === importedCourse.课程号 && 
              c.班号 === importedCourse.班号.toString() // 确保班号类型匹配
            );

            if (course) {
              // 检查是否已经选择了这门课
              if (!this.isCourseSelected(course)) {
                this.selectCourse(course, false); // false表示不是旁听
                imported++;
              } else {
                skipped++;
              }
            } else {
              console.warn('未找到课程:', importedCourse);
              notFound++;
            }
          });

          const message = [
            `导入完成：`,
            `成功导入 ${imported} 门课程`,
            `已选课程 ${skipped} 门`,
            notFound > 0 ? `未找到 ${notFound} 门课程` : ''
          ].filter(Boolean).join('\n');

          alert(message);
        },
        shouldShowCourse(weekday, period) {
          const courseInfo = this.getCourseTimeInfo(weekday, period);
          if (!courseInfo) return false;

          const course = courseInfo.course;
          const weekType = courseInfo.weekType;
          
          // 检查周次范围
          const weekRanges = this.parseWeekRange(course.起止周);
          const isInWeekRange = weekRanges.some(range => 
            this.currentWeek >= range.start && this.currentWeek <= range.end
          );

          // 检查单双周
          const weekTypeMatch = 
            weekType === 'all' || 
            (weekType === '单' && this.isCurrentWeekOdd) ||
            (weekType === '双' && !this.isCurrentWeekOdd);

          return isInWeekRange && weekTypeMatch;
        },
        parseWeekRange(weekRangeStr) {
          if (!weekRangeStr) return { start: 1, end: 16 };
          
          const ranges = weekRangeStr.split(/[,，]/).map(range => {
            const [start, end] = range.split('-').map(Number);
            return { start, end };
          });
          
          return ranges;
        },
        getCourseDetailUrl(course) {
          const baseUrl = 'https://elective.pku.edu.cn/elective2008/edu/pku/stu/elective/controller/courseDetail/getCourseDetail.do';
          return `${baseUrl}?kclx=BK&course_seq_no=${course.执行计划编号}`;
        },
        removeCourseByItem(item) {
          const index = this.selectedCourses.findIndex(c => 
            c.课程号 === item.课程号 && c.班号 === item.班号
          );
          if (index !== -1) {
            this.selectedCourses.splice(index, 1);
          }
        },
        csvToJSON(csv) {
          const lines = csv.split('\n');
          const headers = lines[0].split(',');
          return lines.slice(1).map(line => {
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            return headers.reduce((obj, header, index) => {
              obj[header] = values[index] ? values[index].replace(/^"|"$/g, '') : '';
              return obj;
            }, {});
          });
        },
        removeItem(item, array) {
          const index = array.indexOf(item);
          if (index >= 0) {
            array.splice(index, 1);
          }
        },
        filterDepartments(item, queryText, itemText) {
          return itemText.toLowerCase().indexOf(queryText.toLowerCase()) > -1;
        }
      }
    })
  </script>

  <style>
    .course-link {
      text-decoration: none;
      color: inherit;
      transition: color 0.3s ease;
    }

    .course-link:hover {
      text-decoration: underline;
      color: var(--v-primary-base);
    }

    .conflict-item {
      background-color: var(--v-error-lighten5) !important;
      border-left: 4px solid var(--v-error-base);
    }

    .audit-item {
      background-color: var(--v-secondary-lighten5) !important;
      opacity: 0.8;
    }

    /* 课程单元格容器 */
    .course-cell-container {
      width: calc(100% / 7) !important; /* 确保每列宽度相等 */
      height: 120px !important; /* 固定高度 */
      padding: 4px !important;
      vertical-align: top !important;
    }

    /* 课程单元格样式 */
    .course-cell {
      width: 100% !important;
      height: 100% !important;
      padding: 8px !important;
      display: flex !important;
      flex-direction: column !important;
      overflow: hidden !important;
      transition: all 0.3s ease;
      border-radius: 4px;
    }

    /* 课程标题样式 */
    .course-title {
      font-size: 0.9rem !important;
      font-weight: 500 !important;
      line-height: 1.2 !important;
      margin-bottom: 4px !important;
      overflow: hidden !important;
      display: -webkit-box !important;
      -webkit-line-clamp: 2 !important; /* 最多显示两行 */
      -webkit-box-orient: vertical !important;
      word-break: break-word !important;
    }

    /* 课程信息样式 */
    .course-info {
      font-size: 0.75rem !important;
      line-height: 1.2 !important;
      overflow: hidden !important;
      display: -webkit-box !important;
      -webkit-line-clamp: 3 !important; /* 最多显示三行 */
      -webkit-box-orient: vertical !important;
      opacity: 0.8;
      flex-grow: 1;
    }

    /* 周次标签样式 */
    .week-type-chip {
      margin-top: 4px !important;
      height: 20px !important;
      font-size: 0.7rem !important;
    }

    /* 浅色主题课程样式 */
    .theme--light .course-regular {
      background-color: #E3F2FD !important;
      border: 1px solid #2196F3 !important;
      border-left: 3px solid #2196F3 !important;
    }

    .theme--light .course-audit {
      background-color: #E8EAF6 !important;
      border: 1px solid #3F51B5 !important;
      border-left: 3px solid #3F51B5 !important;
    }

    /* 深色主题课程样式 */
    .theme--dark .course-regular {
      background-color: rgba(33, 150, 243, 0.15) !important;  /* 柔和的蓝色 */
      border: 1px solid rgba(33, 150, 243, 0.5) !important;
      border-left: 3px solid #2196F3 !important;
    }

    .theme--dark .course-audit {
      background-color: rgba(156, 39, 176, 0.15) !important;  /* 柔和的紫色 */
      border: 1px solid rgba(156, 39, 176, 0.5) !important;
      border-left: 3px solid #9C27B0 !important;
    }

    /* 单双周透明度 */
    .course-alternate {
      opacity: 0.85 !important;
    }

    /* 悬浮效果 */
    .course-cell:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 1;
    }

    /* 响应式调整 */
    @media (max-width: 960px) {
      .course-cell-container {
        height: 100px !important;
      }
      
      .course-title {
        font-size: 0.8rem !important;
        -webkit-line-clamp: 1 !important;
      }
      
      .course-info {
        font-size: 0.7rem !important;
        -webkit-line-clamp: 2 !important;
      }
    }

    @media (max-width: 600px) {
      .course-cell-container {
        height: 80px !important;
      }
      
      .course-title {
        font-size: 0.75rem !important;
      }
      
      .course-info {
        font-size: 0.65rem !important;
        -webkit-line-clamp: 1 !important;
      }
      
      .week-type-chip {
        display: none !important;
      }
    }

    /* 搜索工具栏样式 */
    .search-toolbar {
      border-radius: 12px !important;
      margin: 16px auto !important;
      max-width: 1200px !important;
      background: rgba(var(--v-background), 0.7) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      min-height: 80px !important;
      display: flex !important;
      align-items: center !important;
    }

    /* 容器样式 */
    .v-toolbar__content {
      height: auto !important;
      padding: 12px 0 !important;
      width: 100% !important;
    }

    /* 搜索行样式 */
    .search-row {
      margin: 0 !important;
      height: 100% !important;
      align-items: center !important;
      justify-content: center !important;
    }

    /* 搜索列样式 */
    .search-col {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 0 8px !important;
    }

    /* 搜索字段统一样式 */
    .search-field {
      width: 100% !important;
      margin: 0 !important;
    }

    /* 输入框统一样式 */
    .v-text-field.rounded-lg .v-input__control > .v-input__slot,
    .v-combobox.rounded-lg .v-input__control > .v-input__slot {
      border-radius: 12px !important;
      min-height: 40px !important;
      max-height: 40px !important;
      padding: 0 12px !important;
    }

    /* 输入框内部布局 */
    .v-input__slot {
      margin-bottom: 0 !important;
    }

    .v-text-field__slot,
    .v-select__slot {
      height: 40px !important;
      display: flex !important;
      align-items: center !important;
    }

    /* 响应式调整 */
    @media (max-width: 960px) {
      .search-toolbar {
        min-height: 70px !important;
      }

      .v-toolbar__content {
        padding: 8px 0 !important;
      }

      .search-col {
        padding: 0 4px !important;
      }

      .v-text-field.rounded-lg .v-input__control > .v-input__slot,
      .v-combobox.rounded-lg .v-input__control > .v-input__slot {
        min-height: 36px !important;
        max-height: 36px !important;
      }
    }

    @media (max-width: 600px) {
      .search-toolbar {
        min-height: 180px !important;
      }

      .search-col {
        margin: 4px 0 !important;
      }
    }

    /* 确保背景色一致 */
    .theme--light .search-field.v-text-field--filled > .v-input__control > .v-input__slot,
    .theme--light .search-field.v-select--filled > .v-input__control > .v-input__slot {
      background: white !important;
    }

    .theme--dark .search-field.v-text-field--filled > .v-input__control > .v-input__slot,
    .theme--dark .search-field.v-select--filled > .v-input__control > .v-input__slot {
      background: rgba(255, 255, 255, 0.05) !important;
    }

    /* 时间表容器样式 */
    .timetable-container {
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      border-radius: 4px !important;
      overflow: hidden !important;
    }

    /* 表格列宽控制 */
    .time-column {
      width: 80px !important;
      min-width: 80px !important;
      white-space: nowrap !important;
      font-size: 0.75rem !important;
      padding: 4px 2px !important;
    }

    .weekday-column {
      width: calc((100% - 80px) / 7) !important;
      font-size: 0.8rem !important;
      padding: 4px 2px !important;
    }

    /* 课程单元格容器 */
    .course-cell-container {
      height: 70px !important;
      padding: 2px !important;
      vertical-align: top !important;
    }

    /* 课程单元格样式 */
    .course-cell {
      padding: 4px !important;
      height: 100% !important;
    }

    /* 课程标题样式 */
    .course-title {
      font-size: 0.8rem !important;
      line-height: 1.1 !important;
      margin-bottom: 2px !important;
      -webkit-line-clamp: 2 !important;
    }

    /* 课程信息样式 */
    .course-info {
      font-size: 0.65rem !important;
      line-height: 1.1 !important;
      -webkit-line-clamp: 2 !important;
    }

    /* 周次标签样式 */
    .week-type-chip {
      height: 16px !important;
      font-size: 0.6rem !important;
      margin-top: 2px !important;
    }

    /* 时间列文字样式 */
    .time-column .text-caption {
      font-size: 0.65rem !important;
      opacity: 0.8;
    }

    /* 响应式调整 */
    @media (max-width: 1264px) {
      .time-column {
        width: 70px !important;
        min-width: 70px !important;
        font-size: 0.7rem !important;
      }

      .weekday-column {
        font-size: 0.75rem !important;
      }

      .course-cell-container {
        height: 65px !important;
      }

      .course-title {
        font-size: 0.75rem !important;
      }

      .course-info {
        font-size: 0.6rem !important;
      }
    }

    @media (max-width: 960px) {
      .time-column {
        width: 60px !important;
        min-width: 60px !important;
        font-size: 0.65rem !important;
      }

      .course-cell-container {
        height: 60px !important;
      }

      .course-title {
        font-size: 0.7rem !important;
        -webkit-line-clamp: 1 !important;
      }

      .course-info {
        font-size: 0.55rem !important;
        -webkit-line-clamp: 1 !important;
      }

      .week-type-chip {
        display: none !important;
      }
    }

    /* 表格边框和分隔线 */
    .v-data-table {
      border: 1px solid rgba(0, 0, 0, 0.12) !important;
    }

    .theme--dark .v-data-table {
      border: 1px solid rgba(255, 255, 255, 0.12) !important;
    }

    .v-data-table th, 
    .v-data-table td {
      border: 1px solid rgba(0, 0, 0, 0.12) !important;
    }

    .theme--dark .v-data-table th, 
    .theme--dark .v-data-table td {
      border: 1px solid rgba(255, 255, 255, 0.12) !important;
    }

    /* 毛玻璃效果基础样式 */
    .glassmorphism-light, .glassmorphism-dark {
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      position: relative !important;
      overflow: hidden !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    }

    /* 亮色主题毛玻璃 */
    .glassmorphism-light {
      background: rgba(255, 255, 255, 0.7) !important;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1) !important;
    }

    .glassmorphism-light::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        120deg,
        rgba(255, 255, 255, 0.3) 0%,
        rgba(255, 255, 255, 0.1) 100%
      );
      z-index: 0;
    }

    /* 暗色主题毛玻璃 */
    .glassmorphism-dark {
      background: rgba(18, 18, 18, 0.7) !important;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2) !important;
    }

    .glassmorphism-dark::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        120deg,
        rgba(255, 255, 255, 0.05) 0%,
        rgba(255, 255, 255, 0.02) 100%
      );
      z-index: 0;
    }

    /* 动态光效 */
    .blur-background {
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(
        circle at center,
        transparent 0%,
        rgba(var(--v-primary-base), 0.05) 45%,
        transparent 70%
      );
      animation: rotate 20s linear infinite;
      z-index: -1;
    }

    /* 确保内容在毛玻璃效果之上 */
    .v-toolbar__title,
    .v-btn {
      position: relative;
      z-index: 1;
    }

    /* 主题切换按钮效果 */
    .theme-toggle-btn {
      transition: transform 0.3s ease !important;
    }

    .theme-toggle-btn:hover {
      transform: rotate(30deg);
    }

    /* 动画效果 */
    @keyframes rotate {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    /* 响应式调整 */
    @media (max-width: 600px) {
      .v-toolbar__title {
        font-size: 1rem !important;
      }
      
      .glassmorphism-light,
      .glassmorphism-dark {
        backdrop-filter: blur(8px) !important;
        -webkit-backdrop-filter: blur(8px) !important;
      }
    }

    /* 优化标题栏内容 */
    .v-toolbar__title {
      font-weight: 500 !important;
      letter-spacing: 0.5px !important;
      background: linear-gradient(
        90deg,
        var(--v-primary-base),
        var(--v-secondary-base)
      );
      -webkit-background-clip: text !important;
      background-clip: text !important;
      color: transparent !important;
      opacity: 0.9;
    }

    /* 确保毛玻璃效果在滚动时保持 */
    .v-app-bar--fixed {
      position: fixed !important;
    }
  </style>
</body>
</html>