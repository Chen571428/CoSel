<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <link href="https://raw.githubusercontent.com/Chen571428/picx-images-hosting/refs/heads/master/favicon.ico" rel="icon" type="image/x-icon">
  <title>PKU CoSel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
</head>
<body>
  <div id="app">
    <v-app>
      <v-main>
        <v-container fluid>
          <v-toolbar flat color="grey lighten-4" class="mb-4">
            <v-text-field
              v-model="search"
              append-icon="mdi-magnify"
              label="搜索课程"
              hide-details
              class="mr-4"
              style="max-width: 300px;"
            ></v-text-field>

            <v-select
              v-model="selectedDepartments"
              :items="departments"
              label="开课单位"
              multiple
              clearable
              chips
              style="max-width: 250px;"
              class="mr-4"
            ></v-select>

            <v-select
              v-model="selectedWeekdays"
              :items="weekdays"
              label="上课时间"
              multiple
              clearable
              chips
              style="max-width: 250px;"
            ></v-select>
          </v-toolbar>

          <v-data-table
            :headers="headers"
            :items="filteredCourses"
            :search="search"
            :custom-filter="() => true"
            :items-per-page="itemsPerPage"
            :footer-props="{
              'items-per-page-options': [10, 20, 25, 50, 100, -1],
              'items-per-page-text': '每页显示:',
              'items-per-page-all-text': '全部',
              showFirstLastPage: true,
              'first-icon': 'mdi-page-first',
              'last-icon': 'mdi-page-last',
              'prev-icon': 'mdi-chevron-left',
              'next-icon': 'mdi-chevron-right'
            }"
            class="elevation-1"
          >
            <template v-slot:item.课程号="{ item }">
              <a 
                :href="getCourseDetailUrl(item)"
                target="_blank"
                class="course-link"
                v-tooltip="'点击查看课程详情'"
              >
                {{ item.课程号 }}
              </a>
            </template>
            
            <template v-slot:item.课程名称="{ item }">
              <a 
                :href="getCourseDetailUrl(item)"
                target="_blank"
                class="course-link"
                v-tooltip="'点击查看课程详情'"
              >
                {{ item.课程名称 }}
              </a>
            </template>

            <template v-slot:item.班号="{ item }">
              <v-chip color="indigo" dark small>
                {{ item.班号 }}
              </v-chip>
            </template>

            <template v-slot:item.学分="{ item }">
              <v-chip color="teal" dark>
                {{ item.学分 }} 学分
              </v-chip>
            </template>

            <template v-slot:item.上课时间="{ item }">
              <div class="text-caption">
                {{ formatWeekday(item.上课时间) }}<br>
                {{ formatTimePeriod(item.上课时间) }}
              </div>
            </template>

            <template v-slot:item.备注="{ item }">
              <v-tooltip bottom max-width="300">
                <template v-slot:activator="{ on }">
                  <v-icon small v-on="on">mdi-information</v-icon>
                </template>
                <span>{{ item.备注 }}</span>
              </v-tooltip>
            </template>

            <template v-slot:item.操作="{ item }">
              <template v-if="isCourseSelected(item)">
                <v-btn
                  small
                  color="error"
                  @click="removeCourseByItem(item)"
                >
                  取消
                </v-btn>
              </template>
              <template v-else>
                <v-btn
                  small
                  color="primary"
                  @click="selectCourse(item, false)"
                >
                  选课
                </v-btn>
                <v-btn
                  small
                  color="secondary"
                  class="ml-2"
                  @click="selectCourse(item, true)"
                >
                  旁听
                </v-btn>
              </template>
            </template>
          </v-data-table>

          <v-card class="mt-6">
            <v-card-title class="primary white--text">
              已选课程（总学分：{{ totalCredits }}）
              <v-btn small dark class="ml-4" @click="exportSchedule">
                <v-icon left>mdi-timetable</v-icon>
                WakeUP课表导出
              </v-btn>
              <v-btn small dark class="ml-2" @click="$refs.fileInput.click()">
                <v-icon left>mdi-file-import</v-icon>
                导入交教务课表
              </v-btn>
              <input
                type="file"
                ref="fileInput"
                accept=".csv"
                style="display: none"
                @change="handleFileUpload"
              >
              <v-btn small dark class="ml-2" @click="dialog = true">
                <v-icon left>mdi-account-school</v-icon>
                交教务课表导出
              </v-btn>
              <v-chip color="red" class="ml-2" v-if="hasTimeConflict">
                存在时间冲突！
              </v-chip>
              <v-btn small dark class="ml-2" @click="showTimetable = !showTimetable">
                <v-icon left>mdi-calendar</v-icon>
                {{ showTimetable ? '列表视图' : '时间表视图' }}
              </v-btn>
            </v-card-title>

            <v-alert
              :type="creditAlertType"
              dense
              v-if="showCreditAlert"
              class="mb-0"
            >
              {{ creditAlertMessage }}
            </v-alert>

            <v-dialog v-model="dialog" max-width="500">
              <v-card>
                <v-card-title class="headline">学生信息</v-card-title>
                <v-card-text>
                  <v-text-field
                    v-model="studentId"
                    label="旁听证号"
                    outlined
                    clearable
                    required
                    class="mb-4"
                    :rules="[v => !!v || '必须填写旁听证号']"
                  ></v-text-field>
                  <v-text-field
                    v-model="studentName"
                    label="学生姓名"
                    outlined
                    clearable
                    required
                    :rules="[v => !!v || '必须填写姓名']"
                  ></v-text-field>
                </v-card-text>
                <v-card-actions>
                  <v-spacer></v-spacer>
                  <v-btn color="error" @click="dialog = false">取消</v-btn>
                  <v-btn color="primary" @click="exportSelectionList">导出CSV</v-btn>
                </v-card-actions>
              </v-card>
            </v-dialog>

            <template v-if="showTimetable">
              <v-row class="px-4 py-2" align="center">
                <v-col cols="auto">
                  <v-select
                    v-model="currentWeek"
                    :items="weekOptions"
                    label="选择周次"
                    dense
                    style="max-width: 150px"
                  ></v-select>
                </v-col>
                <v-col>
                  <v-chip small>{{ isCurrentWeekOdd ? '单周' : '双周' }}</v-chip>
                </v-col>
              </v-row>

              <v-simple-table>
                <template v-slot:default>
                  <thead>
                    <tr>
                      <th class="text-center">时间</th>
                      <th 
                        v-for="dateInfo in weekDates" 
                        :key="dateInfo.weekday" 
                        class="text-center"
                      >
                        {{ dateInfo.weekday }}<br>
                        <span class="text-caption">{{ dateInfo.month }}/{{ dateInfo.date }}</span>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(period, index) in schedule" :key="index">
                      <td class="text-center" style="white-space: nowrap;">
                        {{ period.time }}<br>
                        <span class="text-caption">{{ period.period }}</span>
                      </td>
                      <td 
                        v-for="(dateInfo, dayIndex) in weekDates" 
                        :key="dateInfo.weekday"
                        class="text-center"
                        :style="getCellStyle(dayIndex, index + 1)"
                      >
                        <template v-if="shouldShowCourse(dayIndex, index + 1)">
                          <div class="course-cell">
                            <v-tooltip bottom>
                              <template v-slot:activator="{ on, attrs }">
                                <a 
                                  :href="getCourseDetailUrl(getCourseTimeInfo(dayIndex, index + 1).course)"
                                  target="_blank"
                                  class="course-link"
                                  v-bind="attrs"
                                  v-on="on"
                                >
                                  <strong>{{ getCourseTimeInfo(dayIndex, index + 1).course.课程名称 }}</strong>
                                </a>
                              </template>
                              <span>点击查看课程详情</span>
                            </v-tooltip>
                            <div class="text-caption">
                              {{ getCourseTimeInfo(dayIndex, index + 1).course.教师 }}<br>
                              {{ getCourseTimeInfo(dayIndex, index + 1).course.开课单位 }}
                              <template v-if="getCourseTimeInfo(dayIndex, index + 1).weekType !== 'all'">
                                <br>
                                <v-chip x-small>
                                  {{ getCourseTimeInfo(dayIndex, index + 1).weekType }}周
                                </v-chip>
                              </template>
                            </div>
                          </div>
                        </template>
                      </td>
                    </tr>
                  </tbody>
                </template>
              </v-simple-table>
            </template>

            <v-list two-line v-else>
              <v-list-item
                v-for="(course, index) in selectedCourses"
                :key="index"
                :class="{'conflict-item': hasConflict(course), 'audit-item': course.isAudit}"
              >
                <v-list-item-content>
                  <v-list-item-title>
                    <v-tooltip bottom>
                      <template v-slot:activator="{ on, attrs }">
                        <a 
                          :href="getCourseDetailUrl(course)"
                          target="_blank"
                          class="course-link"
                          v-bind="attrs"
                          v-on="on"
                        >
                          {{ course.课程名称 }}
                        </a>
                      </template>
                      <span>点击查看课程详情</span>
                    </v-tooltip>
                    <v-chip v-if="course.isAudit" x-small color="grey" class="ml-1">旁听</v-chip>
                  </v-list-item-title>
                  <v-list-item-subtitle>
                    <template v-for="(time, index) in parseTime(course)">
                      {{ weekdays[time.weekday - 1] }} 第{{ time.start }}-{{ time.end }}节
                      <template v-if="time.weekType !== 'all'">({{ time.weekType }})</template>
                      <template v-if="index < parseTime(course).length - 1">、</template>
                    </template>
                    | 教师：{{ course.教师 }} | 
                    班号：{{ course.班号 }} | 
                    学分：{{ course.学分 }}
                    <v-chip x-small color="error" v-if="hasConflict(course)">
                      时间冲突
                    </v-chip>
                  </v-list-item-subtitle>
                </v-list-item-content>
                
                <v-list-item-action>
                  <v-switch
                    v-model="course.isAudit"
                    label="旁听"
                    dense
                    hide-details
                    color="primary"
                    class="mt-0"
                  ></v-switch>
                  <v-btn icon @click="removeCourse(index)">
                    <v-icon color="red">mdi-delete</v-icon>
                  </v-btn>
                </v-list-item-action>
              </v-list-item>
            </v-list>
          </v-card>
        </v-container>
      </v-main>
    </v-app>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  
  <script>
    new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      data: () => ({
        courses: [], // 初始为空数组
        search: '',
        selectedDepartments: [],
        selectedWeekdays: [],
        selectedCourses: [],
        dialog: false,
        studentId: '',
        studentName: '',
        itemsPerPage: 20,
        headers: [
          { text: '课程号', value: '课程号', width: '120px' },
          { text: '班号', value: '班号', width: '80px' },
          { text: '课程名称', value: '课程名称', minWidth: '200px' },
          { text: '课程类型', value: '课程类型', width: '120px' },
          { text: '开课单位', value: '开课单位', width: '150px' },
          { text: '学分', value: '学分', width: '100px' },
          { text: '上课时间', value: '上课时间', width: '150px' },
          { text: '教师', value: '教师', width: '120px' },
          { text: '备注', value: '备注', width: '80px' },
          { text: '操作', value: '操作', width: '150px' }
        ],
        showTimetable: false,
        tab: null,
        schedule: [
          { period: "第一节", time: "08:00—08:50" },
          { period: "第二节", time: "09:00—09:50" },
          { period: "第三节", time: "10:10—11:00" },
          { period: "第四节", time: "11:10—12:00" },
          { period: "第五节", time: "13:00—13:50" },
          { period: "第六节", time: "14:00—14:50" },
          { period: "第七节", time: "15:10—16:00" },
          { period: "第八节", time: "16:10—17:00" },
          { period: "第九节", time: "17:10—18:00" },
          { period: "第十节", time: "18:40—19:30" },
          { period: "第十一节", time: "19:40—20:30" },
          { period: "第十二节", time: "20:40—21:30" }
        ],
        currentWeek: 1,
        semesterStartDate: new Date(2025, 1, 17), // 2025年2月17日，注意月份从0开始
        totalWeeks: 18,
      }),
      async created() {
        try {
          const response = await fetch('https://raw.githubusercontent.com/Chen571428/CoSel/refs/heads/main/getCourseList/unique_courses.csv');
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          const csvText = await response.text();
          // 处理可能的BOM字符
          const cleanCsvText = csvText.replace(/^\uFEFF/, '');
          // 使用原有的csvToJSON方法转换数据
          this.courses = this.csvToJSON(cleanCsvText).map(course => ({
            ...course,
            weekday: course.上课时间.match(/星期[一二三四五六日]/)?.[0] || ''
          }));
        } catch (error) {
          console.error('Error fetching course data:', error);
          alert('获取课程数据失败，请刷新页面重试');
        }
      },
      computed: {
        departments() {
          return [...new Set(this.courses.map(c => c.开课单位))];
        },
        weekdays() {
          return ['星期一', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'];
        },
        filteredCourses() {
          return this.courses.filter(course => {
            const departmentMatch = this.selectedDepartments.length === 0 || 
              this.selectedDepartments.includes(course.开课单位);
            const weekdayMatch = this.selectedWeekdays.length === 0 || 
              this.selectedWeekdays.includes(this.formatWeekday(course.上课时间));
            const searchMatch = !this.search || 
              Object.values(course).some(value => 
                value.toString().toLowerCase().includes(this.search.toLowerCase())
              );
            return departmentMatch && weekdayMatch && searchMatch;
          });
        },
        totalCredits() {
          return this.selectedCourses
            .filter(c => !c.isAudit)
            .reduce((sum, c) => sum + Number(c.学分), 0);
        },
        timeConflicts() {
          const conflicts = [];
          
          // 遍历所有已选课程
          for (let i = 0; i < this.selectedCourses.length; i++) {
            const course1 = this.selectedCourses[i];
            const times1 = this.parseTime(course1);
            
            // 与后续的每个课程比较
            for (let j = i + 1; j < this.selectedCourses.length; j++) {
              const course2 = this.selectedCourses[j];
              const times2 = this.parseTime(course2);
              
              // 检查两个课程的所有时间段是否存在冲突
              const hasConflict = times1.some(t1 => 
                times2.some(t2 => this.checkTimeConflict(t1, t2))
              );
              
              if (hasConflict) {
                conflicts.push([course1.id, course2.id]);
              }
            }
          }
          
          return conflicts;
        },
        hasTimeConflict() {
          return this.timeConflicts.length > 0;
        },
        showCreditAlert() {
          return this.totalCredits >= 25;
        },
        creditAlertType() {
          return this.totalCredits >= 30 ? 'error' : 'warning';
        },
        creditAlertMessage() {
          if (this.totalCredits >= 30) return '学分超过限制（≥30），请调整选课！';
          if (this.totalCredits >= 25) return '学分超过推荐值（≥25），请注意学业负担！';
          return '';
        },
        weekOptions() {
          return Array.from({ length: this.totalWeeks }, (_, i) => ({
            text: `第${i + 1}周`,
            value: i + 1
          }));
        },
        weekDates() {
          const dates = [];
          const weekStart = new Date(this.semesterStartDate);
          weekStart.setDate(weekStart.getDate() + (this.currentWeek - 1) * 7);
          
          for (let i = 0; i < 7; i++) {
            const date = new Date(weekStart);
            date.setDate(date.getDate() + i);
            dates.push({
              weekday: this.weekdays[i],
              date: date.getDate(),
              month: date.getMonth() + 1
            });
          }
          return dates;
        },
        isCurrentWeekOdd() {
          return this.currentWeek % 2 === 1;
        }
      },
      methods: {
        formatWeekday(timeStr) {
          const weekdays = timeStr.match(/星期[一二三四五六日]/g) || [];
          return weekdays.join('、');
        },
        formatTimePeriod(timeStr) {
          const periods = timeStr.split(/(?=星期)/).map(segment => {
            const match = segment.match(/\(第(\d+)节-第(\d+)节\)(?:\(([单双])\))?/);
            if (match) {
              const weekType = match[3] ? `(${match[3]})` : '';
              return `第${match[1]}-${match[2]}节${weekType}`;
            }
            return '';
          }).filter(Boolean);
          return periods.join('、');
        },
        selectCourse(course, isAudit) {
          if (!this.isCourseSelected(course)) {
            this.selectedCourses.push({
              ...course,
              id: `${course.课程号}_${course.班号}`,
              isAudit: isAudit
            });
          }
        },
        removeCourse(index) {
          this.selectedCourses.splice(index, 1);
        },
        isCourseSelected(course) {
          return this.selectedCourses.some(c => 
            c.课程号 === course.课程号 && c.班号 === course.班号
          );
        },
        parseTime(course) {
          const weekdayMap = {一:1, 二:2, 三:3, 四:4, 五:5, 六:6, 日:7};
          const times = [];
          
          // 分割多个上课时间段
          const timeSegments = course.上课时间.split(/(?=星期)/);
          
          timeSegments.forEach(segment => {
            const match = segment.match(/星期([一二三四五六日])\(第(\d+)节-第(\d+)节\)(?:\(([单双])\))?/);
            if (match) {
              times.push({
                weekday: weekdayMap[match[1]],
                start: parseInt(match[2]),
                end: parseInt(match[3]),
                weekType: match[4] || 'all', // 'all' 表示每周，'单' 表示单周，'双' 表示双周
                id: course.id
              });
            }
          });
          
          return times;
        },
        checkTimeConflict(time1, time2) {
          // 如果不是同一天，不冲突
          if (time1.weekday !== time2.weekday) return false;
          
          // 检查周类型（单双周）
          if (time1.weekType !== time2.weekType && 
              time1.weekType !== 'all' && 
              time2.weekType !== 'all') {
            return false; // 单周和双周的课不冲突
          }
          
          // 检查时间段是否重叠
          const hasTimeOverlap = (
            (time1.start >= time2.start && time1.start <= time2.end) ||
            (time2.start >= time1.start && time2.start <= time1.end)
          );
          
          return hasTimeOverlap;
        },
        hasConflict(course) {
          return this.timeConflicts.some(pair => 
            pair.includes(course.id)
          );
        },
        exportSchedule() {
          if (this.selectedCourses.length === 0) {
            alert('请先选择课程');
            return;
          }

          const csvRows = [];
          this.selectedCourses.forEach(course => {
            const times = this.parseTime(course);
            const location = this.extractLocation(course.备注);
            const weekRange = this.formatWeekRange(course.起止周);
            
            // 为每个时间段创建一行
            times.forEach(time => {
              csvRows.push([
                course.课程名称,
                time.weekday,
                time.start,
                time.end,
                course.教师,
                location,
                weekRange
              ].map(value => `"${value}"`).join(','));
            });
          });

          const csvContent = "课程名称,星期,开始节数,结束节数,老师,地点,周数\n" + 
            csvRows.join('\n');

          this.downloadCSV(csvContent, 'wakeup_schedule.csv');
        },
        exportSelectionList() {
          if (!this.studentId || !this.studentName) {
            alert('请填写旁听证号和姓名');
            return;
          }

          const selectedCourses = this.selectedCourses.filter(course => !course.isAudit);
          
          if (selectedCourses.length === 0) {
            alert('没有正式选课课程');
            this.dialog = false;
            return;
          }

          const csvContent = "旁听证号,姓名,开课院系,课程名称,学分,课程号,班号\n" + 
            selectedCourses.map(course => {
              return [
                this.studentId,
                `"${this.studentName}"`,
                `"${course.开课单位}"`,
                `"${course.课程名称}"`,
                course.学分,
                course.课程号,
                course.班号
              ].join(',');
            }).join('\n');

          this.downloadCSV(csvContent, 'course_selection.csv');
          this.dialog = false;
        },
        downloadCSV(content, filename) {
          const blob = new Blob(["\ufeff" + content], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          
          link.setAttribute("href", url);
          link.setAttribute("download", filename);
          link.style.visibility = "hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },
        extractLocation(remark) {
          if (!remark) return '未知地点';
          const locationMatch = remark.match(/([^，,]+?)[，,]/);
          return locationMatch ? locationMatch[1] : remark;
        },
        formatWeekRange(weekStr) {
          if (!weekStr) return '1-16';
          return weekStr
            .replace(/、/g, ',')
            .replace(/，/g, ',')
            .replace(/\s+/g, '');
        },
        getCourseAtTime(weekday, period) {
          return this.selectedCourses.find(course => {
            const times = this.parseTime(course);
            return times.some(time => 
              time.weekday === weekday + 1 && 
              time.start <= period && 
              time.end >= period
            );
          });
        },
        getCourseTimeInfo(weekday, period) {
          const course = this.selectedCourses.find(course => {
            const times = this.parseTime(course);
            return times.some(time => 
              time.weekday === weekday + 1 && 
              time.start <= period && 
              time.end >= period
            );
          });

          if (!course) return null;

          const times = this.parseTime(course);
          const timeInfo = times.find(time => 
            time.weekday === weekday + 1 && 
            time.start <= period && 
            time.end >= period
          );

          return {
            course,
            weekType: timeInfo.weekType
          };
        },
        getCellStyle(weekday, period) {
          const courseInfo = this.getCourseTimeInfo(weekday, period);
          if (!courseInfo || !this.shouldShowCourse(weekday, period)) return {};
          
          const { course, weekType } = courseInfo;
          const isAudit = course.isAudit;
          
          let backgroundColor = isAudit ? '#E8EAF6' : '#E3F2FD';
          let borderColor = isAudit ? '#3F51B5' : '#2196F3';
          
          if (weekType === '单' || weekType === '双') {
            backgroundColor = backgroundColor + '80';
          }
          
          return {
            backgroundColor: backgroundColor,
            borderLeft: `3px solid ${borderColor}`,
            padding: '0'
          };
        },
        handleFileUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const csv = e.target.result;
              const courses = this.parseImportedCSV(csv);
              this.importCourses(courses);
              this.$refs.fileInput.value = ''; // 重置文件输入
            } catch (error) {
              alert('导入失败：' + error.message);
            }
          };
          reader.readAsText(file);
        },
        parseImportedCSV(csv) {
          const lines = csv.split('\n');
          if (lines.length < 2) throw new Error('文件格式不正确');

          const headers = lines[0].split(',').map(h => h.trim());
          const requiredHeaders = ['旁听证号', '姓名', '开课院系', '课程名称', '学分', '课程号', '班号'];
          
          // 验证必要的列是否存在
          requiredHeaders.forEach(header => {
            if (!headers.includes(header)) {
              throw new Error(`缺少必要的列：${header}`);
            }
          });

          return lines.slice(1)
            .filter(line => line.trim())
            .map(line => {
              const values = line.split(',').map(v => v.trim());
              const courseData = {};
              headers.forEach((header, index) => {
                courseData[header] = values[index]?.replace(/^"|"$/g, '').trim() || '';
              });
              return courseData;
            });
        },
        importCourses(importedCourses) {
          let imported = 0;
          let skipped = 0;
          let notFound = 0;

          importedCourses.forEach(importedCourse => {
            // 在可用课程中查找匹配的课程
            const course = this.courses.find(c => 
              c.课程号 === importedCourse.课程号 && 
              c.班号 === importedCourse.班号.toString() // 确保班号类型匹配
            );

            if (course) {
              // 检查是否已经选择了这门课
              if (!this.isCourseSelected(course)) {
                this.selectCourse(course, false); // false表示不是旁听
                imported++;
              } else {
                skipped++;
              }
            } else {
              console.warn('未找到课程:', importedCourse);
              notFound++;
            }
          });

          const message = [
            `导入完成：`,
            `成功导入 ${imported} 门课程`,
            `已选课程 ${skipped} 门`,
            notFound > 0 ? `未找到 ${notFound} 门课程` : ''
          ].filter(Boolean).join('\n');

          alert(message);
        },
        shouldShowCourse(weekday, period) {
          const courseInfo = this.getCourseTimeInfo(weekday, period);
          if (!courseInfo) return false;

          const course = courseInfo.course;
          const weekType = courseInfo.weekType;
          
          // 检查周次范围
          const weekRanges = this.parseWeekRange(course.起止周);
          const isInWeekRange = weekRanges.some(range => 
            this.currentWeek >= range.start && this.currentWeek <= range.end
          );

          // 检查单双周
          const weekTypeMatch = 
            weekType === 'all' || 
            (weekType === '单' && this.isCurrentWeekOdd) ||
            (weekType === '双' && !this.isCurrentWeekOdd);

          return isInWeekRange && weekTypeMatch;
        },
        parseWeekRange(weekRangeStr) {
          if (!weekRangeStr) return { start: 1, end: 16 };
          
          const ranges = weekRangeStr.split(/[,，]/).map(range => {
            const [start, end] = range.split('-').map(Number);
            return { start, end };
          });
          
          return ranges;
        },
        getCourseDetailUrl(course) {
          const baseUrl = 'https://elective.pku.edu.cn/elective2008/edu/pku/stu/elective/controller/courseDetail/getCourseDetail.do';
          return `${baseUrl}?kclx=BK&course_seq_no=${course.执行计划编号}`;
        },
        removeCourseByItem(item) {
          const index = this.selectedCourses.findIndex(c => 
            c.课程号 === item.课程号 && c.班号 === item.班号
          );
          if (index !== -1) {
            this.selectedCourses.splice(index, 1);
          }
        },
        csvToJSON(csv) {
          const lines = csv.split('\n');
          const headers = lines[0].split(',');
          return lines.slice(1).map(line => {
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            return headers.reduce((obj, header, index) => {
              obj[header] = values[index] ? values[index].replace(/^"|"$/g, '') : '';
              return obj;
            }, {});
          });
        }
      }
    })
  </script>

  <style>
    .conflict-item {
      background-color: #ffebee !important;
      border-left: 4px solid #ff5252;
    }
    .audit-item {
      background-color: #f5f5f5 !important;
      opacity: 0.8;
    }
    .v-data-table td {
      height: auto !important;
      white-space: nowrap;
    }
    .v-data-table-header th {
      font-weight: 600 !important;
    }
    .v-alert {
      border-radius: 0;
    }
    .v-card__title.primary {
      padding: 16px;
    }
    .v-list-item__action {
      flex-direction: column;
      align-items: flex-end;
    }
    .v-timeline-item__body {
      max-width: 300px;
    }
    .course-cell {
      padding: 4px;
      min-height: 60px;
    }
    .course-link {
      text-decoration: none;
      color: inherit;
    }
    .course-link:hover {
      text-decoration: underline;
      color: #1976D2;
    }
    .v-data-table {
      width: 100%;
    }
    .v-data-table td {
      white-space: normal !important;
      word-break: break-word;
    }
    .v-data-footer__select {
      margin-right: 14px !important;
    }
    .v-data-footer__select .v-input__slot {
      margin-bottom: 0;
    }
    .container.fluid {
      max-width: none !important;
      width: 100%;
      padding: 16px;
    }
  </style>
</body>
</html>