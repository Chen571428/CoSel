<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
</head>
<body>
  <div id="app">
    <v-app>
      <v-main>
        <v-container>
          <v-toolbar flat color="grey lighten-4" class="mb-4">
            <v-text-field
              v-model="search"
              append-icon="mdi-magnify"
              label="搜索课程"
              hide-details
              class="mr-4"
              style="max-width: 300px;"
            ></v-text-field>

            <v-select
              v-model="selectedDepartments"
              :items="departments"
              label="开课单位"
              multiple
              clearable
              chips
              style="max-width: 250px;"
              class="mr-4"
            ></v-select>

            <v-select
              v-model="selectedWeekdays"
              :items="weekdays"
              label="上课时间"
              multiple
              clearable
              chips
              style="max-width: 250px;"
            ></v-select>
          </v-toolbar>

          <v-data-table
            :headers="headers"
            :items="filteredCourses"
            :search="search"
            :items-per-page="10"
            class="elevation-1"
          >
            <template v-slot:item.课程号="{ item }">
              <v-chip color="blue-grey" dark small>
                {{ item.课程号 }}
              </v-chip>
            </template>

            <template v-slot:item.班号="{ item }">
              <v-chip color="indigo" dark small>
                {{ item.班号 }}
              </v-chip>
            </template>

            <template v-slot:item.学分="{ item }">
              <v-chip color="teal" dark>
                {{ item.学分 }} 学分
              </v-chip>
            </template>

            <template v-slot:item.上课时间="{ item }">
              <div class="text-caption">
                {{ formatWeekday(item.上课时间) }}<br>
                {{ formatTimePeriod(item.上课时间) }}
              </div>
            </template>

            <template v-slot:item.备注="{ item }">
              <v-tooltip bottom max-width="300">
                <template v-slot:activator="{ on }">
                  <v-icon small v-on="on">mdi-information</v-icon>
                </template>
                <span>{{ item.备注 }}</span>
              </v-tooltip>
            </template>

            <template v-slot:item.操作="{ item }">
              <div>
                <v-btn
                  small
                  color="primary"
                  @click="selectCourse(item, false)"
                  :disabled="isCourseSelected(item)"
                  class="mb-1"
                >
                  {{ isCourseSelected(item) ? '已选' : '选课' }}
                </v-btn>
                <v-btn
                  small
                  color="secondary"
                  @click="selectCourse(item, true)"
                  :disabled="isCourseSelected(item)"
                >
                  旁听
                </v-btn>
              </div>
            </template>
          </v-data-table>

          <v-card class="mt-6">
            <v-card-title class="primary white--text">
              已选课程（总学分：{{ totalCredits }}）
              <v-btn small dark class="ml-4" @click="exportSchedule">
                <v-icon left>mdi-timetable</v-icon>
                WakeUP课表导出
              </v-btn>
              <v-btn small dark class="ml-2" @click="dialog = true">
                <v-icon left>mdi-account-school</v-icon>
                交教务课表导出
              </v-btn>
              <v-chip color="red" class="ml-2" v-if="hasTimeConflict">
                存在时间冲突！
              </v-chip>
            </v-card-title>

            <v-alert
              :type="creditAlertType"
              dense
              v-if="showCreditAlert"
              class="mb-0"
            >
              {{ creditAlertMessage }}
            </v-alert>

            <v-dialog v-model="dialog" max-width="500">
              <v-card>
                <v-card-title class="headline">学生信息</v-card-title>
                <v-card-text>
                  <v-text-field
                    v-model="studentId"
                    label="旁听证号"
                    outlined
                    clearable
                    required
                    class="mb-4"
                    :rules="[v => !!v || '必须填写旁听证号']"
                  ></v-text-field>
                  <v-text-field
                    v-model="studentName"
                    label="学生姓名"
                    outlined
                    clearable
                    required
                    :rules="[v => !!v || '必须填写姓名']"
                  ></v-text-field>
                </v-card-text>
                <v-card-actions>
                  <v-spacer></v-spacer>
                  <v-btn color="error" @click="dialog = false">取消</v-btn>
                  <v-btn color="primary" @click="exportSelectionList">导出CSV</v-btn>
                </v-card-actions>
              </v-card>
            </v-dialog>

            <v-list two-line>
              <v-list-item
                v-for="(course, index) in selectedCourses"
                :key="index"
                :class="{'conflict-item': hasConflict(course), 'audit-item': course.isAudit}"
              >
                <v-list-item-content>
                  <v-list-item-title>
                    {{ course.课程名称 }}
                    <v-chip v-if="course.isAudit" x-small color="grey" class="ml-1">旁听</v-chip>
                  </v-list-item-title>
                  <v-list-item-subtitle>
                    {{ formatWeekday(course.上课时间) }} {{ formatTimePeriod(course.上课时间) }} | 
                    教师：{{ course.教师 }} | 
                    班号：{{ course.班号 }} | 
                    学分：{{ course.学分 }}
                    <v-chip x-small color="error" v-if="hasConflict(course)">
                      时间冲突
                    </v-chip>
                  </v-list-item-subtitle>
                </v-list-item-content>
                
                <v-list-item-action>
                  <v-switch
                    v-model="course.isAudit"
                    label="旁听"
                    dense
                    hide-details
                    color="primary"
                    class="mt-0"
                  ></v-switch>
                  <v-btn icon @click="removeCourse(index)">
                    <v-icon color="red">mdi-delete</v-icon>
                  </v-btn>
                </v-list-item-action>
              </v-list-item>
            </v-list>
          </v-card>
        </v-container>
      </v-main>
    </v-app>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  
  <script>
    const csvData = `序号,课程号,课程名称,课程类型,开课单位,班号,学分,执行计划编号,起止周,上课时间,教师,备注
1,00405596,量子材料前沿讲座,专业任选,物理学院,1,2,BZ2425200405596_19857,1-16,星期三(第7节-第8节),陈昱安,物理楼西563，一学年的课，2024秋季已听讲座的同学选课，研本合上
2981,04831420,数据结构与算法 (B),理科生必修,信息科学技术学院,9,3,BZ2425204831420_97900,1-16,星期二(第7节-第9节),郭炜,Python，同时选04830494“数据结构与算法上机”9号班
2984,04832580,算法设计与分析（研讨型小班）,专业必修,信息科学技术学院,9,0,BZ2425204832580_94452,1-16,星期五(第5节-第6节),汪小林,小班会按照老师给的实际分班名单手动添加，冲突选课无法添加。
2986,04833800,电子系统基础训练,专业必修,信息科学技术学院,9,1,BZ2425204833800_92352,9-15,,王青,第9-15周周三晚上6:00-9:30理科2号楼2258
2987,01130200,遗传学,专业必修,生命科学学院,1,3,BZ2425201130200_90100,1-16,星期一(第7节-第8节)(单)星期三(第7节-第8节),宋艳陆剑,生科生技必修
`.trim();

    function csvToJSON(csv) {
      const lines = csv.split('\n');
      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        return headers.reduce((obj, header, index) => {
          obj[header] = values[index] ? values[index].replace(/^"|"$/g, '') : '';
          return obj;
        }, {});
      });
    }

    new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      data: () => ({
        search: '',
        selectedDepartments: [],
        selectedWeekdays: [],
        selectedCourses: [],
        dialog: false,
        studentId: '',
        studentName: '',
        headers: [
          { text: '课程号', value: '课程号', width: '120px' },
          { text: '班号', value: '班号', width: '80px' },
          { text: '课程名称', value: '课程名称' },
          { text: '课程类型', value: '课程类型', width: '120px' },
          { text: '开课单位', value: '开课单位', width: '150px' },
          { text: '学分', value: '学分', width: '100px' },
          { text: '上课时间', value: '上课时间', width: '150px' },
          { text: '教师', value: '教师', width: '120px' },
          { text: '备注', value: '备注', width: '80px' },
          { text: '操作', value: '操作', width: '150px' }
        ],
        courses: csvToJSON(csvData).map(course => ({
          ...course,
          weekday: course.上课时间.match(/星期[一二三四五六日]/)?.[0] || ''
        }))
      }),
      computed: {
        departments() {
          return [...new Set(this.courses.map(c => c.开课单位))];
        },
        weekdays() {
          return [...new Set(this.courses.map(c => this.formatWeekday(c.上课时间)))];
        },
        filteredCourses() {
          return this.courses.filter(course => {
            const departmentMatch = this.selectedDepartments.length === 0 || 
              this.selectedDepartments.includes(course.开课单位);
            const weekdayMatch = this.selectedWeekdays.length === 0 || 
              this.selectedWeekdays.includes(this.formatWeekday(course.上课时间));
            const searchMatch = !this.search || 
              Object.values(course).some(value => 
                value.toString().toLowerCase().includes(this.search.toLowerCase())
              );
            return departmentMatch && weekdayMatch && searchMatch;
          });
        },
        totalCredits() {
          return this.selectedCourses
            .filter(c => !c.isAudit)
            .reduce((sum, c) => sum + Number(c.学分), 0);
        },
        hasTimeConflict() {
          return this.timeConflicts.length > 0;
        },
        timeConflicts() {
          const timeSlots = this.selectedCourses.map(c => this.parseTime(c));
          const conflicts = [];
          for (let i = 0; i < timeSlots.length; i++) {
            for (let j = i + 1; j < timeSlots.length; j++) {
              if (this.checkTimeConflict(timeSlots[i], timeSlots[j])) {
                conflicts.push([timeSlots[i].id, timeSlots[j].id]);
              }
            }
          }
          return conflicts;
        },
        showCreditAlert() {
          return this.totalCredits >= 25;
        },
        creditAlertType() {
          return this.totalCredits >= 30 ? 'error' : 'warning';
        },
        creditAlertMessage() {
          if (this.totalCredits >= 30) return '学分超过限制（≥30），请调整选课！';
          if (this.totalCredits >= 25) return '学分超过推荐值（≥25），请注意学业负担！';
          return '';
        }
      },
      methods: {
        formatWeekday(timeStr) {
          return timeStr.match(/星期[一二三四五六日]/)?.[0] || '';
        },
        formatTimePeriod(timeStr) {
          return timeStr.replace(/星期[一二三四五六日]\(|\)/g, '');
        },
        selectCourse(course, isAudit) {
          if (!this.isCourseSelected(course)) {
            this.selectedCourses.push({
              ...course,
              id: course.课程号 + '_' + course.班号,
              isAudit: isAudit
            });
          }
        },
        removeCourse(index) {
          this.selectedCourses.splice(index, 1);
        },
        isCourseSelected(course) {
          return this.selectedCourses.some(c => 
            c.课程号 === course.课程号 && c.班号 === course.班号
          );
        },
        parseTime(course) {
          const weekdayMap = {一:1, 二:2, 三:3, 四:4, 五:5, 六:6, 日:7};
          const match = course.上课时间.match(/星期([一二三四五六日])\(第(\d+)节-第(\d+)节\)/);
          return {
            weekday: weekdayMap[match[1]],
            start: parseInt(match[2]),
            end: parseInt(match[3]),
            id: course.id
          };
        },
        checkTimeConflict(a, b) {
          return a.weekday === b.weekday && 
                ((a.start >= b.start && a.start <= b.end) ||
                 (b.start >= a.start && b.start <= a.end));
        },
        hasConflict(course) {
          return this.timeConflicts.some(pair => 
            pair.includes(course.id)
          );
        },
        exportSchedule() {
          if (this.selectedCourses.length === 0) {
            alert('请先选择课程');
            return;
          }

          const csvContent = "课程名称,星期,开始节数,结束节数,老师,地点,周数\n" + 
            this.selectedCourses.map(course => {
              const timeInfo = this.parseWakeupTime(course.上课时间);
              const location = this.extractLocation(course.备注);
              const weekRange = this.formatWeekRange(course.起止周);
              
              return [
                `"${course.课程名称}"`,
                timeInfo.weekday,
                timeInfo.startSection,
                timeInfo.endSection,
                `"${course.教师}"`,
                `"${location}"`,
                `"${weekRange}"`
              ].join(',');
            }).join('\n');

          this.downloadCSV(csvContent, 'wakeup_schedule.csv');
        },
        exportSelectionList() {
          if (!this.studentId || !this.studentName) {
            alert('请填写旁听证号和姓名');
            return;
          }

          const selectedCourses = this.selectedCourses.filter(course => !course.isAudit);
          
          if (selectedCourses.length === 0) {
            alert('没有正式选课课程');
            this.dialog = false;
            return;
          }

          const csvContent = "旁听证号,姓名,开课院系,课程名称,学分,课程号,班号\n" + 
            selectedCourses.map(course => {
              return [
                this.studentId,
                `"${this.studentName}"`,
                `"${course.开课单位}"`,
                `"${course.课程名称}"`,
                course.学分,
                course.课程号,
                course.班号
              ].join(',');
            }).join('\n');

          this.downloadCSV(csvContent, 'course_selection.csv');
          this.dialog = false;
        },
        downloadCSV(content, filename) {
          const blob = new Blob(["\ufeff" + content], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          
          link.setAttribute("href", url);
          link.setAttribute("download", filename);
          link.style.visibility = "hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },
        parseWakeupTime(timeStr) {
          const weekdayMap = { '一': 1, '二': 2, '三': 3, '四': 4, '五': 5, '六': 6, '日': 7 };
          const match = timeStr.match(/星期([一二三四五六日])\(第(\d+)节-第(\d+)节\)/);
          return {
            weekday: weekdayMap[match[1]],
            startSection: match[2],
            endSection: match[3]
          };
        },
        extractLocation(remark) {
          const locationMatch = remark.match(/(.+?)[，,]/);
          return locationMatch ? locationMatch[1] : '未知地点';
        },
        formatWeekRange(weekStr) {
          return weekStr
            .replace(/、/g, ',')
            .replace(/，/g, ',')
            .replace(/\s+/g, '');
        }
      }
    })
  </script>

  <style>
    .conflict-item {
      background-color: #ffebee !important;
      border-left: 4px solid #ff5252;
    }
    .audit-item {
      background-color: #f5f5f5 !important;
      opacity: 0.8;
    }
    .v-data-table td {
      white-space: nowrap;
    }
    .v-data-table-header th {
      font-weight: 600 !important;
    }
    .v-alert {
      border-radius: 0;
    }
    .v-card__title.primary {
      padding: 16px;
    }
    .v-list-item__action {
      flex-direction: column;
      align-items: flex-end;
    }
  </style>
</body>
</html>