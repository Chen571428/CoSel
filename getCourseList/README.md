# 北京大学课程爬虫修复版

## 问题修复

原脚本存在以下问题，已在此版本中修复：

1. **HTTP -> HTTPS**: 网站已迁移到HTTPS，更新了所有URL
2. **验证码要求**: 网站现在需要验证码，添加了验证码处理功能
3. **学期参数**: 更新了默认学期参数为当前学期

## 主要修改

### 1. URL更新
- 将所有HTTP URL更新为HTTPS
- `http://dean.pku.edu.cn` -> `https://dean.pku.edu.cn`

### 2. 验证码支持
- 添加了`getVerificationCode()`函数下载验证码图片
- 添加了`createSession()`函数管理会话
- 更新了所有请求函数以支持会话和验证码

### 3. 错误处理改进
- 增强了JSON解析错误处理
- 添加了更详细的错误信息
- 改进了验证码错误检测

### 4. 进度显示和时间估算
- 添加了进度条显示当前下载进度
- 提供时间估算和剩余时间显示
- 显示实际耗时统计

## 使用方法

### 基本用法
```bash
python3 downloader.py
```

### 指定参数
```bash
# 查询特定学期的课程
python3 downloader.py -ys 24-25-2

# 查询特定课程
python3 downloader.py -c "数据结构"

# 查询特定教师的课程
python3 downloader.py -t "张三"

# 查询特定院系的课程
python3 downloader.py -y "1"  # 1代表数学科学学院

# 启用详细日志
python3 downloader.py -l 1

# 强制覆盖已存在的文件
python3 downloader.py -f
```

### 验证码处理
脚本运行时会：
1. 自动下载验证码图片保存为`vercode.png`
2. 提示用户打开图片查看验证码
3. 等待用户输入验证码

### 进度显示
脚本现在提供：
- **时间估算**: 开始前显示预计所需时间
- **进度条**: 实时显示下载进度
- **剩余时间**: 动态更新预计剩余时间
- **总耗时**: 完成后显示实际用时

示例输出：
```
Estimated time: 3.7 minutes
Fetching course data: 45%|████▌     | 132/294 [01:23<01:42, ETA=1.7min]
Total time taken: 3.2 minutes
```

### 参数说明
- `-c, --coursename`: 课程名称（默认为空，查询所有）
- `-t, --teachername`: 教师姓名（默认为空，查询所有）
- `-s, --coursetype`: 课程类型代码（默认0，查询所有）
- `-y, --yuanxi`: 院系代码（默认0，查询所有）
- `-ys`: 学年学期（如24-25-2表示2024-2025学年第2学期）
- `-r, --retry`: 重试次数（默认3）
- `-l, --loglevel`: 日志级别（0=DEBUG, 1=INFO, 2=WARNING, 3=ERROR）
- `-p, --parallel`: 启用并行处理（注意：验证码模式下不支持）
- `-f, --force`: 强制覆盖已存在的输出文件
- `-v, --vercode`: 直接提供验证码（可选）

## 输出文件
脚本会生成CSV文件，文件名格式：
`CN{课程名}_TN{教师名}_YS{学年学期}_CT{课程类型}_YX{院系}.csv`

## 依赖安装
```bash
pip install -r requirements.txt
```

新增依赖：
- `tqdm`: 用于显示进度条

## 注意事项

1. **验证码**: 由于网站现在需要验证码，每次运行都需要手动输入
2. **并行处理**: 在验证码模式下，并行处理被禁用以避免会话冲突
3. **网络连接**: 确保能够访问北大教务网站
4. **时间估算**: 基于平均请求速度估算，实际时间可能因网络状况而异

## 故障排除

### 常见错误
1. **"No courselist in response"**: 验证码错误或已过期，重新运行脚本
2. **"Failed to create session"**: 网络连接问题，检查网络设置
3. **"Failed to get options"**: 无法访问主页面，可能是网络问题

### 调试建议
- 使用`-l 1`启用详细日志查看详细错误信息
- 检查生成的`vercode.png`文件确认验证码是否正确下载
- 确认学期参数格式正确（如24-25-2）

## 测试
运行测试脚本检查API连接：
```bash
python3 test_api.py
```

## 性能优化

### 时间估算算法
- 基于历史平均请求时间（约0.75秒/请求）
- 动态调整基于实际进度
- 自动适应网络状况变化

### 进度显示特性
- 实时更新进度百分比
- 动态ETA计算
- 友好的时间格式显示（秒/分钟）
